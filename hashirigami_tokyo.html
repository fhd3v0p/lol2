<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>走り紙 | SHADOW RUNNERS</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono:wght@400&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;700&display=swap');
        
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #16161d;
            --bg-tertiary: #1e1e2e;
            --text-primary: #ff6b35;
            --text-secondary: #888;
            --accent-red: #ff2d55;
            --accent-purple: #af52de;
            --accent-blue: #007aff;
            --shadow-color: rgba(255, 45, 85, 0.3);
            --glow-color: rgba(255, 107, 53, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));
            color: var(--text-primary);
            font-family: 'Share Tech Mono', 'Noto Sans JP', monospace;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Теневые эффекты бегущих теней */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: -100%;
            width: 300%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(255, 45, 85, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 30%, rgba(175, 82, 222, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 70%, rgba(255, 107, 53, 0.1) 0%, transparent 50%);
            animation: shadowRun 15s linear infinite;
            pointer-events: none;
            z-index: 1;
        }

        @keyframes shadowRun {
            0% { transform: translateX(0); }
            100% { transform: translateX(100px); }
        }

        /* Glitch эффект */
        .glitch-container {
            position: relative;
            display: inline-block;
        }

        .glitch-container::before,
        .glitch-container::after {
            content: attr(data-text);
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            pointer-events: none;
        }

        .glitch-container.active::before {
            animation: glitch1 0.5s infinite;
            color: var(--accent-red);
            z-index: 1;
        }

        .glitch-container.active::after {
            animation: glitch2 0.5s infinite;
            color: var(--accent-blue);
            z-index: 2;
        }

        @keyframes glitch1 {
            0%, 100% { transform: translate(0); opacity: 0; }
            20% { transform: translate(-2px, 2px); opacity: 1; }
            40% { transform: translate(-2px, -2px); opacity: 1; }
            60% { transform: translate(2px, 2px); opacity: 1; }
            80% { transform: translate(2px, -2px); opacity: 1; }
        }

        @keyframes glitch2 {
            0%, 100% { transform: translate(0); opacity: 0; }
            30% { transform: translate(3px, 3px); opacity: 0.8; }
            60% { transform: translate(-3px, 3px); opacity: 0.8; }
        }

        .phone-container {
            width: 390px;
            height: 740px;
            margin: 20px auto;
            background: linear-gradient(145deg, #1a1a1a, #0f0f0f);
            border: 3px solid #333;
            border-radius: 30px;
            padding: 15px;
            box-shadow: 
                0 0 50px var(--shadow-color),
                inset 0 0 20px rgba(0, 0, 0, 0.5);
            position: relative;
            z-index: 10;
        }

        .screen {
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            border-radius: 20px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.8);
        }

        .phone-header {
            background: var(--bg-tertiary);
            padding: 10px 15px;
            font-size: 11px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .signal-bars {
            display: flex;
            gap: 2px;
        }

        .signal-bar {
            width: 3px;
            height: 8px;
            background: var(--text-primary);
            opacity: 0.3;
            transition: opacity 0.3s;
        }

        .signal-bar.active {
            opacity: 1;
            box-shadow: 0 0 5px var(--glow-color);
        }

        .battery {
            color: var(--accent-red);
            animation: batteryPulse 3s infinite;
        }

        @keyframes batteryPulse {
            0%, 70% { opacity: 1; }
            85%, 100% { opacity: 0.3; }
        }

        .content-area {
            flex: 1;
            padding: 20px 15px;
            overflow-y: auto;
            position: relative;
        }

        /* ВВОДНЫЙ ЭКРАН */
        .intro-screen {
            text-align: center;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
        }

        .intro-title {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 20px;
            background: linear-gradient(45deg, var(--text-primary), var(--accent-red));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: titleGlow 4s ease-in-out infinite alternate;
        }

        @keyframes titleGlow {
            from { filter: drop-shadow(0 0 10px var(--glow-color)); }
            to { filter: drop-shadow(0 0 30px var(--glow-color)); }
        }

        .intro-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .warning-box {
            background: rgba(255, 45, 85, 0.1);
            border: 1px solid var(--accent-red);
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            animation: warningPulse 2s infinite;
        }

        @keyframes warningPulse {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 45, 85, 0.3); }
            50% { box-shadow: 0 0 25px rgba(255, 45, 85, 0.6); }
        }

        .choice-button {
            width: 100%;
            padding: 15px;
            margin: 8px 0;
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            border: 1px solid #444;
            border-radius: 10px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .choice-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, var(--glow-color), transparent);
            transition: left 0.5s;
        }

        .choice-button:hover::before {
            left: 100%;
        }

        .choice-button:hover {
            border-color: var(--text-primary);
            box-shadow: 0 0 20px var(--glow-color);
            transform: translateY(-2px);
        }

        .choice-button.dangerous {
            border-color: var(--accent-red);
            background: linear-gradient(135deg, rgba(255, 45, 85, 0.1), var(--bg-tertiary));
        }

        .choice-button.dangerous:hover {
            box-shadow: 0 0 20px rgba(255, 45, 85, 0.5);
        }

        .japanese-text {
            font-family: 'Noto Sans JP', sans-serif;
            font-weight: 300;
        }

        .japanese-symbol {
            font-family: 'Noto Sans JP', sans-serif;
            font-size: 20px;
            color: var(--accent-red);
            display: inline-block;
            margin-right: 8px;
            animation: symbolGlow 3s infinite alternate;
        }

        @keyframes symbolGlow {
            from { text-shadow: 0 0 10px var(--accent-red); }
            to { text-shadow: 0 0 20px var(--accent-red), 0 0 30px var(--accent-red); }
        }

        /* ИГРОВЫЕ ЭЛЕМЕНТЫ */
        .investigation-meter {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #444;
            border-radius: 5px;
            padding: 8px;
            font-size: 10px;
            z-index: 100;
        }

        .meter-bar {
            width: 60px;
            height: 6px;
            background: #222;
            border-radius: 3px;
            margin-top: 4px;
            overflow: hidden;
        }

        .meter-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--text-primary), var(--accent-red));
            width: 0%;
            transition: width 0.5s ease;
        }

        .story-entry {
            background: rgba(255, 107, 53, 0.05);
            border: 1px solid rgba(255, 107, 53, 0.2);
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            position: relative;
            animation: entrySlide 0.5s ease-out;
        }

        @keyframes entrySlide {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .story-entry.corrupted {
            background: rgba(255, 45, 85, 0.1);
            border-color: var(--accent-red);
            animation: entryGlitch 0.3s ease-out;
        }

        @keyframes entryGlitch {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            75% { transform: translateX(3px); }
        }

        .story-entry.shadow {
            background: rgba(175, 82, 222, 0.1);
            border-color: var(--accent-purple);
        }

        .story-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .story-content {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .story-timestamp {
            font-size: 10px;
            color: var(--text-secondary);
            text-align: right;
            opacity: 0.7;
        }

        .choices-container {
            padding: 15px;
            border-top: 1px solid #333;
            background: var(--bg-tertiary);
        }

        .interaction-prompt {
            text-align: center;
            color: var(--accent-purple);
            font-size: 12px;
            margin-bottom: 15px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        /* ИНТЕРАКТИВНЫЕ ЭЛЕМЕНТЫ */
        .mini-game {
            background: var(--bg-secondary);
            border: 1px solid #444;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
        }

        .shadow-tracker {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .shadow-spot {
            aspect-ratio: 1;
            background: var(--bg-tertiary);
            border: 2px solid #444;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .shadow-spot::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, var(--accent-purple), transparent);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .shadow-spot.active::before {
            opacity: 0.8;
            animation: shadowPulse 1s infinite;
        }

        @keyframes shadowPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.5); }
        }

        .shadow-spot:hover {
            border-color: var(--text-primary);
            box-shadow: 0 0 15px var(--glow-color);
        }

        .progress-indicator {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 20px 0;
        }

        .progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #444;
            transition: background 0.3s;
        }

        .progress-dot.active {
            background: var(--text-primary);
            box-shadow: 0 0 10px var(--glow-color);
        }

        .progress-dot.completed {
            background: var(--accent-red);
        }

        /* АНИМАЦИИ ДЛЯ АТМОСФЕРЫ */
        .atmospheric-text {
            opacity: 0;
            animation: fadeInUp 2s ease-out forwards;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .typing-effect {
            overflow: hidden;
            border-right: 2px solid var(--text-primary);
            animation: typing 3s steps(30) forwards, blink 0.5s infinite;
        }

        @keyframes typing {
            from { width: 0; }
            to { width: 100%; }
        }

        @keyframes blink {
            50% { border-color: transparent; }
        }

        .shadow-runner {
            position: absolute;
            width: 30px;
            height: 60px;
            background: linear-gradient(180deg, var(--accent-purple), transparent);
            border-radius: 50% 50% 0 0;
            opacity: 0.3;
            animation: runAcross 4s linear infinite;
        }

        @keyframes runAcross {
            0% { left: -30px; transform: scaleX(1); }
            50% { transform: scaleX(-1); }
            100% { left: calc(100% + 30px); transform: scaleX(-1); }
        }

        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="investigation-meter">
        <div class="japanese-text">追跡レベル</div>
        <div class="meter-bar">
            <div class="meter-fill" id="investigationFill"></div>
        </div>
    </div>

    <div class="phone-container">
        <div class="screen">
            <div class="phone-header">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div class="signal-bars">
                        <div class="signal-bar active"></div>
                        <div class="signal-bar active"></div>
                        <div class="signal-bar"></div>
                        <div class="signal-bar"></div>
                    </div>
                    <span class="japanese-text" style="font-size: 10px;">DoCoMo FOMA</span>
                </div>
                <div class="battery">08% ⚠️</div>
            </div>

            <div id="gameContent" class="content-area">
                <!-- Контент будет динамически загружаться -->
            </div>

            <div id="choicesContainer" class="choices-container">
                <div class="interaction-prompt japanese-text">システム起動中...</div>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
            tg.setHeaderColor('#0a0a0f');
            tg.setBackgroundColor('#0a0a0f');
        }

        class HashirigamiGame {
            constructor() {
                this.gameContent = document.getElementById('gameContent');
                this.choicesContainer = document.getElementById('choicesContainer');
                this.investigationLevel = 0;
                this.gameState = {
                    chapter: 0,
                    shadowsFound: 0,
                    fearLevel: 0,
                    choicesMade: [],
                    playerName: '',
                    firstPlaythrough: true,
                    minigamesCompleted: [],
                    secretsUnlocked: []
                };

                if (tg?.initDataUnsafe?.user) {
                    this.gameState.playerName = tg.initDataUnsafe.user.first_name || 'Исследователь';
                }

                this.init();
            }

            init() {
                this.showIntroScreen();
            }

            showIntroScreen() {
                this.gameContent.innerHTML = `
                    <div class="intro-screen">
                        <div class="intro-title">
                            <span class="glitch-container" data-text="走り紙">走り紙</span>
                        </div>
                        <div style="font-size: 18px; color: var(--accent-red); margin-bottom: 15px;">
                            SHADOW RUNNERS
                        </div>
                        <div class="intro-subtitle">
                            Токио, 2005 год<br>
                            В подземных переходах станции Синдзюку<br>
                            появились странные тени, которые бегут<br>
                            быстрее человека и повторяют движения<br>
                            случайных прохожих.
                        </div>
                        
                        <div class="warning-box">
                            <div style="color: var(--accent-red); font-size: 12px; font-weight: bold;">⚠️ ПРЕДУПРЕЖДЕНИЕ</div>
                            <div style="font-size: 11px; margin-top: 5px;">
                                Найден телефон пропавшей девушки.<br>
                                Последние записи содержат аномальные данные.<br>
                                Просмотр на ваш страх и риск.
                            </div>
                        </div>

                        <div style="margin: 30px 0;">
                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 10px;">
                                Выберите уровень погружения:
                            </div>
                        </div>
                    </div>
                `;

                this.setChoices([
                    {
                        text: '🔍 Поверхностное расследование',
                        action: () => this.startGame('casual'),
                        description: 'Безопасный режим с минимумом хоррора'
                    },
                    {
                        text: '👁️ Глубокое погружение',
                        action: () => this.startGame('deep'),
                        description: 'Полное погружение в мистику',
                        dangerous: true
                    },
                    {
                        text: '📱 Информация об устройстве',
                        action: () => this.showDeviceInfo(),
                        description: 'Техническая информация'
                    }
                ]);

                // Запускаем глитч эффект на заголовке
                setTimeout(() => {
                    const glitchEl = document.querySelector('.glitch-container');
                    if (glitchEl) glitchEl.classList.add('active');
                }, 2000);
            }

            startGame(mode) {
                this.gameState.mode = mode;
                this.gameState.chapter = 1;
                this.updateInvestigationLevel(10);
                this.showChapter1();
            }

            showChapter1() {
                this.addShadowRunner();
                
                this.gameContent.innerHTML = `
                    <div>
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 16px; color: var(--accent-red);">
                                <span class="japanese-symbol">始</span>ГЛАВА 1: НАХОДКА
                            </div>
                            <div style="font-size: 11px; color: var(--text-secondary);">
                                23:47 • Станция Синдзюку • Подземный переход
                            </div>
                        </div>

                        <div class="story-entry atmospheric-text">
                            <div class="story-header">
                                <span>📱 Запись от лица Мики Танигучи (谷口美紀)</span>
                                <span>15.11.05</span>
                            </div>
                            <div class="story-content">
                                Возвращалась домой с работы. Последний поезд, пустые переходы. 
                                И вдруг заметила - моя тень бежит не в ту сторону.
                                <br><br>
                                Я остановилась. Тень продолжила движение, скользнула по стене 
                                и исчезла за углом. Как будто у неё есть собственная воля.
                            </div>
                        </div>

                        <div class="mini-game">
                            <div style="color: var(--accent-purple); margin-bottom: 15px;">
                                🎮 ИНТЕРАКТИВ: Найдите аномальные тени
                            </div>
                            <div class="shadow-tracker" id="shadowTracker1">
                                ${Array(9).fill().map((_, i) => `
                                    <div class="shadow-spot" data-index="${i}" onclick="game.checkShadow(${i}, 'shadowTracker1')"></div>
                                `).join('')}
                            </div>
                            <div style="font-size: 11px; color: var(--text-secondary);">
                                Кликните на области, где могут прятаться бегущие тени
                            </div>
                        </div>

                        <div class="progress-indicator">
                            <div class="progress-dot active"></div>
                            <div class="progress-dot"></div>
                            <div class="progress-dot"></div>
                            <div class="progress-dot"></div>
                            <div class="progress-dot"></div>
                        </div>
                    </div>
                `;

                // Инициализируем мини-игру с тенями
                this.initShadowGame('shadowTracker1', [2, 5, 7], () => {
                    this.updateInvestigationLevel(20);
                    this.setChoices([
                        {
                            text: '📝 Записать наблюдения',
                            action: () => this.showChapter2(),
                            description: 'Попытаться понять логику явления'
                        },
                        {
                            text: '🏃‍♀️ Последовать за тенью',
                            action: () => this.showChapter2Alternative(),
                            description: 'Риск, но больше информации',
                            dangerous: true
                        },
                        {
                            text: '📱 Снять на камеру',
                            action: () => this.showCameraMinigame(),
                            description: 'Попытаться зафиксировать аномалию'
                        }
                    ]);
                });

                this.setChoices([
                    {
                        text: '⏳ Подождать завершения анализа теней...',
                        action: () => {},
                        description: 'Сначала найдите все тени в мини-игре'
                    }
                ]);
            }

            showChapter2() {
                this.gameState.chapter = 2;
                this.addShadowRunner();
                
                this.gameContent.innerHTML = `
                    <div>
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 16px; color: var(--accent-red);">
                                <span class="japanese-symbol">追</span>ГЛАВА 2: ПРЕСЛЕДОВАНИЕ
                            </div>
                            <div style="font-size: 11px; color: var(--text-secondary);">
                                00:15 • Район Сибуя • Торговый центр 109
                            </div>
                        </div>

                        <div class="story-entry corrupted">
                            <div class="story-header">
                                <span>📱 Экстренная запись • Мики</span>
                                <span>16.11.05</span>
                            </div>
                            <div class="story-content">
                                Они повсюду! Тени бегут по стенам торгового центра. 
                                Повторяют движения людей, но с задержкой в несколько секунд.
                                <br><br>
                                <span style="color: var(--accent-red);">САМОЕ СТРАШНОЕ:</span> 
                                Когда человек останавливается, его тень продолжает бежать. 
                                И тогда человек начинает бежать за ней...
                            </div>
                        </div>

                        <div class="story-entry shadow">
                            <div class="story-header">
                                <span>🏃‍♀️ Свидетель: Охранник центра</span>
                                <span>16.11.05</span>
                            </div>
                            <div class="story-content">
                                "За последнюю неделю трое посетителей начали бегать 
                                по центру без остановки. Врачи не могут их остановить. 
                                Говорят, что преследуют свою тень."
                            </div>
                        </div>

                        <div class="mini-game">
                            <div style="color: var(--accent-purple); margin-bottom: 15px;">
                                ⚡ РЕАКЦИЯ: Остановите убегающую тень!
                            </div>
                            <div style="position: relative; height: 60px; background: var(--bg-tertiary); border-radius: 8px; overflow: hidden; margin: 15px 0;">
                                <div id="runningShadow" style="position: absolute; width: 30px; height: 50px; background: linear-gradient(180deg, var(--accent-purple), transparent); left: 0; top: 5px; border-radius: 50% 50% 0 0; transition: left 2s linear;"></div>
                                <div style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: var(--accent-red); font-size: 20px;">🎯</div>
                            </div>
                            <button class="choice-button" id="catchShadowBtn" onclick="game.catchShadow()">
                                ⚡ ПОЙМАТЬ ТЕНЬ
                            </button>
                            <div id="shadowResult" style="font-size: 11px; margin-top: 10px; text-align: center; color: var(--text-secondary);"></div>
                        </div>
                    </div>
                `;

                this.startShadowChase();
                
                setTimeout(() => {
                    this.updateInvestigationLevel(35);
                    this.setChoices([
                        {
                            text: '🚇 Спуститься в метро',
                            action: () => this.showChapter3(),
                            description: 'Искать источник аномалии'
                        },
                        {
                            text: '📞 Связаться с полицией',
                            action: () => this.showPoliceRoute(),
                            description: 'Попытаться получить помощь'
                        },
                        {
                            text: '🏥 Найти пострадавших',
                            action: () => this.showVictimsRoute(),
                            description: 'Помочь одержимым бегом людям',
                            dangerous: true
                        }
                    ]);
                }, 3000);
            }

            showChapter3() {
                this.gameState.chapter = 3;
                this.updateInvestigationLevel(50);
                
                this.gameContent.innerHTML = `
                    <div>
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 16px; color: var(--accent-red);">
                                <span class="japanese-symbol">深</span>ГЛАВА 3: ИСТОЧНИК
                            </div>
                            <div style="font-size: 11px; color: var(--text-secondary);">
                                01:30 • Подземка • Заброшенная платформа
                            </div>
                        </div>

                        <div class="story-entry corrupted">
                            <div class="story-header">
                                <span>📱 Последняя запись • Мики</span>
                                <span>17.11.05</span>
                            </div>
                            <div class="story-content">
                                Нашла их логово. Старая платформа, закрытая с 1980-х. 
                                Стены покрыты тенями, которые движутся сами по себе.
                                <br><br>
                                В центре - девушка. Она танцует, а сотни теней повторяют 
                                её движения по всему Токио. <span style="color: var(--accent-red);">ОНА КОНТРОЛИРУЕТ ИХ ВСЕХ.</span>
                                <br><br>
                                Кажется, она заметила меня. Начинает поворачиваться...
                            </div>
                        </div>

                        <div class="story-entry shadow">
                            <div class="story-content" style="text-align: center; font-style: italic;">
                                <span class="typing-effect" style="color: var(--accent-purple);">
                                    "Хочешь танцевать со мной?"
                                </span>
                                <br><br>
                                <span style="font-size: 11px; color: var(--text-secondary);">
                                    [ЗВУК ОБРЫВАЕТСЯ]
                                </span>
                            </div>
                        </div>

                        <div class="mini-game">
                            <div style="color: var(--accent-red); margin-bottom: 15px; text-align: center;">
                                💃 ФИНАЛЬНЫЙ ВЫБОР: Что делать с Теневой Танцовщицей?
                            </div>
                            <div style="background: rgba(175, 82, 222, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0; text-align: center;">
                                <div style="font-size: 12px; margin-bottom: 10px;">
                                    Она предлагает тебе присоединиться к танцу теней.<br>
                                    Твой выбор определит судьбу всех одержимых людей в Токио.
                                </div>
                            </div>
                        </div>

                        <div class="progress-indicator">
                            <div class="progress-dot completed"></div>
                            <div class="progress-dot completed"></div>
                            <div class="progress-dot completed"></div>
                            <div class="progress-dot active"></div>
                            <div class="progress-dot"></div>
                        </div>
                    </div>
                `;

                this.setChoices([
                    {
                        text: '💃 Принять приглашение',
                        action: () => this.showEnding('join'),
                        description: 'Стать частью танца теней навсегда',
                        dangerous: true
                    },
                    {
                        text: '⚡ Попытаться остановить её',
                        action: () => this.showEnding('fight'),
                        description: 'Риск, но шанс спасти всех',
                        dangerous: true
                    },
                    {
                        text: '🎥 Записать всё на камеру',
                        action: () => this.showEnding('record'),
                        description: 'Создать доказательства для мира'
                    },
                    {
                        text: '🏃‍♀️ Убежать и забыть',
                        action: () => this.showEnding('escape'),
                        description: 'Сохранить себя, но оставить других'
                    }
                ]);
            }

            showEnding(choice) {
                this.gameState.chapter = 5;
                this.updateInvestigationLevel(100);
                
                let endingContent = '';
                let endingClass = 'story-entry';
                
                if (choice === 'join') {
                    endingClass += ' shadow';
                    endingContent = `
                        <div class="story-content">
                            Ты принимаешь её руку. Твоё тело становится лёгким, как тень.
                            <br><br>
                            Теперь ты часть вечного танца. Твоя тень бегает по улицам Токио, 
                            увлекая за собой случайных прохожих в бесконечную погоню.
                            <br><br>
                            <span style="color: var(--accent-purple); font-style: italic;">
                                "Добро пожаловать в семью теней..."
                            </span>
                        </div>
                    `;
                } else if (choice === 'fight') {
                    endingClass += ' corrupted';
                    endingContent = `
                        <div class="story-content">
                            Ты пытаешься остановить танец. Теневая Танцовщица смеётся.
                            <br><br>
                            Но твоя решимость сильнее её чар. Связь рвётся. 
                            По всему Токио люди останавливаются, больше не преследуя свои тени.
                            <br><br>
                            <span style="color: var(--accent-red);">
                                Танцовщица исчезает, но обещает вернуться...
                            </span>
                        </div>
                    `;
                } else if (choice === 'record') {
                    endingContent = `
                        <div class="story-content">
                            Ты записываешь всё на камеру телефона. Доказательства!
                            <br><br>
                            Видео становится вирусным. Мир узнаёт о Теневых Танцовщицах. 
                            Ученые начинают исследования. Людей предупреждают об опасности.
                            <br><br>
                            <span style="color: var(--text-primary);">
                                Ты стала героем. Но тени всё ещё там, ждут неосторожных...
                            </span>
                        </div>
                    `;
                } else {
                    endingContent = `
                        <div class="story-content">
                            Ты убегаешь, не оглядываясь. 
                            <br><br>
                            Танец продолжается. Люди по всему Токио всё ещё бегут за своими тенями. 
                            Но ты в безопасности... пока твоя собственная тень не начнёт действовать самостоятельно.
                            <br><br>
                            <span style="color: var(--text-secondary); font-style: italic;">
                                Некоторые тайны лучше не трогать...
                            </span>
                        </div>
                    `;
                }

                this.gameContent.innerHTML = `
                    <div>
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 16px; color: var(--accent-red);">
                                <span class="japanese-symbol">終</span>ФИНАЛ: ${this.getEndingTitle(choice)}
                            </div>
                        </div>

                        <div class="${endingClass}">
                            ${endingContent}
                        </div>

                        <div class="story-entry" style="text-align: center;">
                            <div style="color: var(--accent-purple); margin-bottom: 15px;">
                                🎭 ЭПИЛОГ
                            </div>
                            <div class="story-content">
                                История Мики показала нам тёмную сторону японских улиц. 
                                Но есть и светлая сторона - искусство, которое объединяет людей.
                                <br><br>
                                Возможно, пора изучить что-то созидательное? 
                                Например, искусство татуировки...
                            </div>
                        </div>

                        <div class="progress-indicator">
                            <div class="progress-dot completed"></div>
                            <div class="progress-dot completed"></div>
                            <div class="progress-dot completed"></div>
                            <div class="progress-dot completed"></div>
                            <div class="progress-dot completed"></div>
                        </div>
                    </div>
                `;

                this.setChoices([
                    {
                        text: '🔄 Пройти другой путь',
                        action: () => location.reload(),
                        description: 'Начать заново с другими выборами'
                    },
                    {
                        text: '🎓 Изучить тату-мастерство',
                        action: () => this.showCoursesOverview(),
                        description: 'Переключиться на созидательное искусство'
                    },
                    {
                        text: '📱 Поделиться историей',
                        action: () => this.shareStory(),
                        description: 'Рассказать друзьям о приключении'
                    }
                ]);
            }

            showCoursesOverview() {
                this.gameContent.innerHTML = `
                    <div>
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 16px; color: var(--text-primary);">
                                <span class="japanese-symbol">学</span>АКАДЕМИЯ ТАТУ-МАСТЕРСТВА
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary);">
                                От теней к свету • Созидательное искусство
                            </div>
                        </div>

                        <div class="story-entry">
                            <div class="story-content">
                                После погружения в мир теней важно вернуться к созидательному искусству. 
                                Татуировки - это способ создавать красоту, а не разрушать.
                            </div>
                        </div>

                        <div style="background: rgba(255, 107, 53, 0.1); border: 1px solid var(--text-primary); border-radius: 10px; padding: 15px; margin: 15px 0;">
                            <div style="font-size: 13px; font-weight: bold; margin-bottom: 15px; color: var(--text-primary);">
                                ДОСТУПНЫЕ КУРСЫ:
                            </div>
                            
                            <div style="margin: 10px 0; padding: 12px; background: rgba(255, 45, 85, 0.1); border-radius: 6px;">
                                <strong>Полный курс тату-мастера</strong> - 22,500₽ <span style="text-decoration: line-through; opacity: 0.6;">45,000₽</span>
                                <br><small>Теория + видео + наставничество • 1-2 месяца</small>
                                <button class="choice-button" style="margin-top: 8px; padding: 8px;" onclick="game.showCourse('full')">
                                    🎓 Подробнее
                                </button>
                            </div>

                            <div style="margin: 10px 0; padding: 12px; background: rgba(175, 82, 222, 0.1); border-radius: 6px;">
                                <strong>SMM для тату-мастеров</strong> - 12,500₽ <span style="text-decoration: line-through; opacity: 0.6;">25,000₽</span>
                                <br><small>Instagram, TikTok, продвижение • 3 недели</small>
                                <button class="choice-button" style="margin-top: 8px; padding: 8px;" onclick="game.showCourse('smm')">
                                    📱 Подробнее
                                </button>
                            </div>

                            <div style="margin: 10px 0; padding: 12px; background: rgba(0, 122, 255, 0.1); border-radius: 6px;">
                                <strong>Procreate для эскизов</strong> - 7,500₽ <span style="text-decoration: line-through; opacity: 0.6;">15,000₽</span>
                                <br><small>Цифровое рисование эскизов</small>
                                <button class="choice-button" style="margin-top: 8px; padding: 8px;" onclick="game.showCourse('procreate')">
                                    🎨 Подробнее
                                </button>
                            </div>
                        </div>

                        <div class="story-entry shadow">
                            <div style="text-align: center;">
                                <div style="color: var(--accent-purple); margin-bottom: 10px;">🎁 ПРОМОКОД</div>
                                <div style="font-size: 18px; font-weight: bold; letter-spacing: 2px; color: var(--text-primary);">
                                    SHADOWS50
                                </div>
                                <div style="font-size: 11px; margin-top: 5px;">
                                    Скидка 50% + бесплатная консультация
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                this.setChoices([
                    {
                        text: '📋 Скопировать промокод',
                        action: () => {
                            if (navigator.clipboard) {
                                navigator.clipboard.writeText('SHADOWS50');
                            }
                            this.showNotification('Промокод SHADOWS50 скопирован!');
                        },
                        description: 'Сохранить в буфер обмена'
                    },
                    {
                        text: '💬 Связаться с консультантом',
                        action: () => this.contactSupport(),
                        description: 'Получить персональную консультацию'
                    }
                ]);
            }

            // СЛУЖЕБНЫЕ МЕТОДЫ

            initShadowGame(trackerId, correctSpots, callback) {
                let foundShadows = 0;
                const total = correctSpots.length;
                
                correctSpots.forEach(index => {
                    setTimeout(() => {
                        const spot = document.querySelector(`#${trackerId} [data-index="${index}"]`);
                        if (spot) spot.classList.add('active');
                    }, Math.random() * 2000);
                });

                window.checkShadow = (index, trackerId) => {
                    const spot = document.querySelector(`#${trackerId} [data-index="${index}"]`);
                    if (correctSpots.includes(index) && spot.classList.contains('active')) {
                        spot.style.borderColor = 'var(--text-primary)';
                        spot.style.boxShadow = '0 0 20px var(--glow-color)';
                        foundShadows++;
                        
                        if (foundShadows === total) {
                            setTimeout(callback, 1000);
                        }
                    } else {
                        spot.style.borderColor = 'var(--accent-red)';
                        setTimeout(() => {
                            spot.style.borderColor = '#444';
                        }, 1000);
                    }
                };
            }

            startShadowChase() {
                const shadow = document.getElementById('runningShadow');
                const btn = document.getElementById('catchShadowBtn');
                const result = document.getElementById('shadowResult');
                
                let shadowPosition = 0;
                let caught = false;
                
                const moveInterval = setInterval(() => {
                    if (caught) return;
                    
                    shadowPosition += 5;
                    shadow.style.left = shadowPosition + 'px';
                    
                    if (shadowPosition > 300) {
                        clearInterval(moveInterval);
                        if (!caught) {
                            result.textContent = '❌ Тень убежала...';
                            result.style.color = 'var(--accent-red)';
                        }
                    }
                }, 100);

                window.catchShadow = () => {
                    if (shadowPosition > 250 && shadowPosition < 310) {
                        caught = true;
                        clearInterval(moveInterval);
                        result.textContent = '✅ Тень поймана! Получены новые данные.';
                        result.style.color = 'var(--text-primary)';
                        this.updateInvestigationLevel(45);
                    } else {
                        result.textContent = '❌ Промах! Тень ускользнула.';
                        result.style.color = 'var(--accent-red)';
                    }
                    btn.disabled = true;
                };
            }

            addShadowRunner() {
                const runner = document.createElement('div');
                runner.className = 'shadow-runner';
                runner.style.top = Math.random() * 200 + 'px';
                this.gameContent.appendChild(runner);
                
                setTimeout(() => {
                    if (runner.parentNode) runner.remove();
                }, 4000);
            }

            updateInvestigationLevel(level) {
                this.investigationLevel = level;
                const fill = document.getElementById('investigationFill');
                if (fill) {
                    fill.style.width = level + '%';
                }
            }

            setChoices(choices) {
                this.choicesContainer.innerHTML = `
                    <div class="interaction-prompt">Выберите действие:</div>
                    ${choices.map(choice => `
                        <button class="choice-button ${choice.dangerous ? 'dangerous' : ''}" onclick="choice.action()">
                            ${choice.text}
                            ${choice.description ? `<div style="font-size: 10px; opacity: 0.7; margin-top: 4px;">${choice.description}</div>` : ''}
                        </button>
                    `).join('')}
                `;

                // Привязываем обработчики
                const buttons = this.choicesContainer.querySelectorAll('.choice-button');
                buttons.forEach((button, index) => {
                    button.onclick = choices[index].action;
                });
            }

            showNotification(text) {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed; top: 50px; right: 20px; 
                    background: var(--text-primary); color: black; 
                    padding: 10px 15px; border-radius: 8px; 
                    z-index: 1000; font-size: 12px;
                    box-shadow: 0 0 20px var(--glow-color);
                `;
                notification.textContent = text;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
            }

            getEndingTitle(choice) {
                const titles = {
                    'join': 'ТАНЕЦ ВЕЧНОСТИ',
                    'fight': 'ГЕРОИЧЕСКОЕ СОПРОТИВЛЕНИЕ', 
                    'record': 'СВИДЕТЕЛЬ ИСТИНЫ',
                    'escape': 'ТЯЖКОЕ БРЕМЯ'
                };
                return titles[choice] || 'НЕИЗВЕСТНАЯ СУДЬБА';
            }

            shareStory() {
                if (tg) {
                    tg.switchInlineQuery('Прошла мистический квест про Теневых Танцовщиц Токио! 🏃‍♀️👻');
                }
            }

            contactSupport() {
                if (tg) {
                    tg.openTelegramLink('https://t.me/your_tattoo_support');
                }
            }

            showDeviceInfo() {
                this.gameContent.innerHTML = `
                    <div>
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 16px; color: var(--accent-blue);">
                                <span class="japanese-symbol">機</span>ИНФОРМАЦИЯ ОБ УСТРОЙСТВЕ
                            </div>
                        </div>

                        <div class="story-entry">
                            <div class="story-content">
                                <strong>Модель:</strong> DoCoMo P901i (2005)<br>
                                <strong>Владелец:</strong> 谷口美紀 (Мики Танигучи)<br>
                                <strong>Статус:</strong> Пропала без вести<br>
                                <strong>Память:</strong> 100MB (частично повреждена)<br>
                                <strong>GPS:</strong> Аномальные координаты<br>
                                <strong>Камера:</strong> 2MP (фиксирует невидимые объекты)
                            </div>
                        </div>

                        <div class="story-entry corrupted">
                            <div class="story-content">
                                ⚠️ <strong>АНОМАЛИИ:</strong><br>
                                • Телефон работает без батареи<br>
                                • Записи восстанавливаются самостоятельно<br>
                                • Камера снимает тени без источника<br>
                                • GPS показывает несуществующие места
                            </div>
                        </div>
                    </div>
                `;

                this.setChoices([
                    {
                        text: '🔍 Начать расследование',
                        action: () => this.showIntroScreen(),
                        description: 'Вернуться к выбору режима'
                    }
                ]);
            }
        }

        // Инициализация игры
        let game;
        document.addEventListener('DOMContentLoaded', () => {
            game = new HashirigamiGame();
        });

        // Атмосферные эффекты
        setInterval(() => {
            if (Math.random() < 0.05) {
                document.body.style.filter = `hue-rotate(${Math.random() * 60}deg)`;
                setTimeout(() => { document.body.style.filter = 'none'; }, 200);
            }
        }, 5000);
    </script>
</body>
</html>
